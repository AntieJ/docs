---
id: twilio-app-tutorial
title: Building a Twilio App in Dark
sidebar_label: Building a Twilio App in Dark
---

Dark allows you to build backends (API endpoints, workers, cron, and data storage) by writing only your business logic, using production traces.

You can access you canvas at darklang.com/a/USERNAME (or USERNAME-CANVASNAME). For this project we recommend https://darklang.com/a/USERNAME-twilioreminder.

We recommend building a hello world API endpoint to get a feel for Dark, as follows:

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b3812ea3-354a-498a-9c53-2255edd29d14/image2.gif](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b3812ea3-354a-498a-9c53-2255edd29d14/image2.gif)

All the major handlers work the same way, but the key for many requests is working directly with incoming data.

## Daily Text Reminder App

We’re building this app: [https://sample-textreminder.builtwithdark.com](https://sample-textreminder.builtwithdark.com/)
It’s an app that will send a text message once per day at a given time to an end user. In this case, we’ll ask the user “did you drink enough water today?” and track their response.

To try out the app and see your traces in the sample canvas text “start” to "+12482653257.”

### Twilio Credentials

To build your own, you’ll need to set up a Twilio account. Your Twilio SID & Token are on the Dashboard.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e00148ff-61b0-4dfb-a48a-a28e14b1db4e/image16.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e00148ff-61b0-4dfb-a48a-a28e14b1db4e/image16.png)

You’ll also need to add a phone number from the “more” menu on the lefthand side, then to the phone number section.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4ee890bc-d53a-427c-a163-71d106a0caf9/image15.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/4ee890bc-d53a-427c-a163-71d106a0caf9/image15.png)

Once you’ve added a phone number, you can configure a webhook:

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9eba78cc-eac6-46fb-b7e3-5f8f15535315/image17.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9eba78cc-eac6-46fb-b7e3-5f8f15535315/image17.png)

### Sending a Message

Dark has a built in Twilio::sendText function. We can call it in a REPL with our own number to verify our webhook.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/953af019-3c19-4a9f-ae04-01814c3e86e4/image4.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/953af019-3c19-4a9f-ae04-01814c3e86e4/image4.png)

[https://darklang.com/a/sample-textreminder#handler=1108947374](https://darklang.com/a/sample-textreminder#handler=1108947374)

### Receiving Responses

After we receive a response, we’ll see a 404 in the side bar section for our webook, which we can create by hitting the “+” button.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/142b7222-52a1-4a2d-8487-805237669586/image3.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/142b7222-52a1-4a2d-8487-805237669586/image3.png)

Once the handler is created, we’re able to see the full incoming trace.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/28fd7a33-983b-4e97-8c26-2946e4b79b94/image19.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/28fd7a33-983b-4e97-8c26-2946e4b79b94/image19.png)

[https://darklang.com/a/sample-textreminder#handler=1004312353](https://darklang.com/a/sample-textreminder#handler=1004312353)

### Processing & Storing Responses

In Dark, you can work directly with incoming traces. More on this in [Trace Driven Development](https://docs.google.com/document/d/15u_iXi5FZXPX-hn71NqMH8vMLfNQMw3NMD8EOui3m2g/edit?folder=0AJNj3YlxhMcIUk9PVA). For this handler, we can parse out the things we care about: a user deciding to start/stop using our service, or telling us if they drank enough water or not.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/26f4b147-1cc1-4930-8de0-140766a1364f/image7.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/26f4b147-1cc1-4930-8de0-140766a1364f/image7.png)

[https://darklang.com/a/sample-textreminder#handler=1004312353](https://darklang.com/a/sample-textreminder#handler=1004312353)

At each expression, we can see what the expression evaluates to for a given trace. Here, we see the From number. In this case we also do some cleaning on the response in case the user had a capital letter or an extraneous space.

For processing the various responses, we’ll use a match statement. More on [Match](https://docs.google.com/document/d/1Z8kw6YXb_olmTG8IGflzb9witUrwfYxCkSaZc3skj90/edit#heading=h.uqb7jxxgc6ij) is available, but the tutorial example has enough context to understand how it works for this case.

### Signup & Quit

Now, let’s do the “start” case. This allows us to give the user our Twilio number, and have them text “start” to begin receiving a daily reminder. We’ll need a data store to keep track of our users, which can be created from the omnibox (cmd/ctrl-k) or the side bar.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/473fb5de-c636-467e-a232-0daf14e65c6d/image1.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/473fb5de-c636-467e-a232-0daf14e65c6d/image1.png)

[https://darklang.com/a/sample-textreminder#db=973891964](https://darklang.com/a/sample-textreminder#db=973891964)

Then, we can write the logic to add users to the datastore when they text “start.” In this case we use the user’s phone number as the unique key.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/43c90246-6ecc-42f1-ba44-3559adfdf4e7/image9.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/43c90246-6ecc-42f1-ba44-3559adfdf4e7/image9.png)

[https://darklang.com/a/sample-textreminder#handler=1004312353](https://darklang.com/a/sample-textreminder#handler=1004312353)

The stop case is very similar, but removes the user from the datastore.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/01457e85-ad28-4ebc-9e41-746db5f9ffc5/image13.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/01457e85-ad28-4ebc-9e41-746db5f9ffc5/image13.png)

[https://darklang.com/a/sample-textreminder#handler=1004312353](https://darklang.com/a/sample-textreminder#handler=1004312353)

To test, you can always send a new reply to the text message (or just message your number) and walk through the trace to see the live values at each step.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/860b75bf-6e87-4777-9666-79b40cf1f098/image11.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/860b75bf-6e87-4777-9666-79b40cf1f098/image11.png)

[https://darklang.com/a/sample-textreminder#handler=1004312353](https://darklang.com/a/sample-textreminder#handler=1004312353)

### Water Tracking

Now we’ll want the cases for when the user responds to the daily question of “did you drink enough water today?”

We’ll want another data store so we can track the daily response by user (side bar or cmd-k).

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/dfeb1b4e-8592-448e-9855-e5238b094e53/image12.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/dfeb1b4e-8592-448e-9855-e5238b094e53/image12.png)

[https://darklang.com/a/sample-textreminder#db=1164294845](https://darklang.com/a/sample-textreminder#db=1164294845)

In this case since we do not want to use the phone number as the unique key, we generate a unique key when storing using the built in DB::generateKey function:

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/019c32e9-fe0b-4e16-b5c1-8e5c4fd3a722/image18.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/019c32e9-fe0b-4e16-b5c1-8e5c4fd3a722/image18.png)

[https://darklang.com/a/sample-textreminder#handler=1004312353](https://darklang.com/a/sample-textreminder#handler=1004312353)

### Catch-all Case

Finally, we need a case for when we don’t match on one of our earlier responses. We’ll want to send a text back to tell the user about the error. To prevent this from blocking other actions, we’ll emit to a background worker.

Here, we emit the user’s number (user) to a background worker named Misunderstood (and see the event as a trace). Once you’ve hit “play” on the emit expression, you should have a 404 for the worker in the side bar that you can hit the + to add. If it does not appear in the sidebar, wait ~ 30s or refresh the browser.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/15daacb7-fc52-4c4d-8291-3e388e778421/image14.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/15daacb7-fc52-4c4d-8291-3e388e778421/image14.png)

[https://darklang.com/a/sample-textreminder#handler=331438030](https://darklang.com/a/sample-textreminder#handler=331438030)

Then we can write the code similar to our earlier REPL to send a message asking for a more clear response:

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3f761083-0eb0-424d-86b4-54555fd8c8b4/image8.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3f761083-0eb0-424d-86b4-54555fd8c8b4/image8.png)

[https://darklang.com/a/sample-textreminder#handler=331438030](https://darklang.com/a/sample-textreminder#handler=331438030)

### Sending Reminder Messages Once A Day

To send each user a reminder once per day, we’ll want to have a cron set to run daily. In this case we’ll get all the users, then emit to a background worker to send the messages.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b3c9643d-e8ca-4343-b1ef-7681e1bf964f/image6.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b3c9643d-e8ca-4343-b1ef-7681e1bf964f/image6.png)

[https://darklang.com/a/sample-textreminder#handler=1621731316](https://darklang.com/a/sample-textreminder#handler=1621731316)

Much like before, this will add the worker to the 404 section where you can add it, with the traces.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/06ae5fd0-78c1-481c-b918-99d28bb65232/image5.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/06ae5fd0-78c1-481c-b918-99d28bb65232/image5.png)

[https://darklang.com/a/sample-textreminder#handler=337743491](https://darklang.com/a/sample-textreminder#handler=337743491)

The code is identical to the code in our REPL:

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1b1137ab-0b8e-4ff1-9087-5224e5eaaab4/image10.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1b1137ab-0b8e-4ff1-9087-5224e5eaaab4/image10.png)

[https://darklang.com/a/sample-textreminder#handler=337743491](https://darklang.com/a/sample-textreminder#handler=337743491)

This is now a fully functioning application.

You could do similar ones for:

- A reminder to stand up once per hour
- A daily reminder to do a task (fill in a personal CRM, floss)
- A weekly reminder to take out the trash

### Additional Topics (for Fun!)

#### Cron at Time of Day

If you’d like to set the reminder to occur at a specific time of day, you can set this using a datastore. There’s a sample canvas [here](https://darklang.com/a/sample-setcrontorunatspecifictime). For this application, add the “reminder time” in the Users table, and add a case to allow users to specify a time (that you would then convert to a Date object).

#### Seeing/Displaying Responses

This API handler shows all checkins for a given user.

[https://darklang.com/a/sample-textreminder#handler=911581692](https://darklang.com/a/sample-textreminder#handler=911581692)

This API handler shows the percentage of “yes” responses for a given user.

[https://darklang.com/a/sample-textreminder#handler=400638438](https://darklang.com/a/sample-textreminder#handler=400638438)